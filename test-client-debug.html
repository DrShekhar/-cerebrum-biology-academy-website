<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side AI Debugging Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #00ff00;
            background: #000;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #111;
        }
        .button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        .button:hover {
            background: #00cc00;
        }
        .code {
            background: #222;
            padding: 10px;
            border-left: 3px solid #00ff00;
            margin: 10px 0;
            overflow-x: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.enabled {
            background: #003300;
            border: 1px solid #00ff00;
        }
        .status.disabled {
            background: #330000;
            border: 1px solid #ff0000;
            color: #ff6666;
        }
        .log-output {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Client-Side AI Debug System Test</h1>
            <p>Interactive testing for the enhanced AI debugging capabilities</p>
        </div>

        <div class="test-section">
            <h2>üìä Debug Status</h2>
            <div id="debugStatus" class="status disabled">
                ‚ùå Debug Mode: Disabled
            </div>
            <div>
                <button class="button" onclick="enableDebug()">Enable Debug</button>
                <button class="button" onclick="disableDebug()">Disable Debug</button>
                <button class="button" onclick="clearLogs()">Clear Logs</button>
                <button class="button" onclick="showStats()">Show Stats</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üöÄ Test AI Requests</h2>
            <div>
                <button class="button" onclick="testSingleRequest()">Single Request Test</button>
                <button class="button" onclick="testMultipleRequests()">Multiple Requests</button>
                <button class="button" onclick="testErrorScenario()">Error Scenario</button>
                <button class="button" onclick="testPerformanceStress()">Performance Stress Test</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üìù Console Commands</h2>
            <div class="code">
// Basic Commands<br>
aiDebug.enable()         // Enable debugging<br>
aiDebug.enable('verbose') // Enable with verbose logging<br>
aiDebug.disable()        // Disable debugging<br>
aiDebug.logs()           // View all logged requests<br>
aiDebug.stats()          // Performance statistics<br>
aiDebug.clear()          // Clear debug logs<br><br>
// Advanced Configuration<br>
aiDebug.config({         // Update configuration<br>
  logLevel: 'verbose',<br>
  showTokenAnalysis: true,<br>
  showPerformanceMetrics: true<br>
})<br><br>
// LocalStorage Control<br>
localStorage.setItem('DEBUG_AI', 'true')  // Persistent enable<br>
localStorage.removeItem('DEBUG_AI')       // Remove persistence
            </div>
        </div>

        <div class="test-section">
            <h2>üìã Live Console Output</h2>
            <div id="consoleOutput" class="log-output">
                Console output will appear here...<br>
                Open browser DevTools console for full debugging experience.
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Features Demonstrated</h2>
            <ul>
                <li>‚úÖ Automatic fetch interception for AI requests</li>
                <li>‚úÖ Request/response timing and performance analysis</li>
                <li>‚úÖ Token usage tracking and cost estimation</li>
                <li>‚úÖ Educational context awareness</li>
                <li>‚úÖ Provider-specific debugging</li>
                <li>‚úÖ Error classification and analysis</li>
                <li>‚úÖ Performance alerts and optimization suggestions</li>
                <li>‚úÖ Beautiful console table formatting</li>
                <li>‚úÖ Persistent debug state via localStorage</li>
                <li>‚úÖ Real-time statistics and monitoring</li>
            </ul>
        </div>
    </div>

    <script>
        // Enhanced Client-Side AI Debugging System Implementation
        // Simplified version for demonstration (full version is in the TypeScript files)

        class ClientAIDebugger {
            constructor() {
                this.enabled = localStorage.getItem('DEBUG_AI') === 'true';
                this.logs = [];
                this.originalFetch = window.fetch;
                this.activeRequests = 0;

                if (this.enabled) {
                    this.setupFetchInterceptor();
                }

                this.setupGlobalAPI();
                this.updateStatus();
            }

            enable(logLevel = 'detailed') {
                this.enabled = true;
                this.logLevel = logLevel;
                localStorage.setItem('DEBUG_AI', 'true');
                this.setupFetchInterceptor();

                console.group('ü§ñ AI Client Debugger Enabled');
                console.log('üìä Log Level:', logLevel);
                console.log('üîç Fetch Interception: Active');
                console.log('‚ö° Performance Metrics: Enabled');
                console.log('ü™ô Token Analysis: Enabled');
                console.groupEnd();

                this.updateStatus();
                this.logToOutput('ü§ñ AI Debugging Enabled');
            }

            disable() {
                this.enabled = false;
                localStorage.removeItem('DEBUG_AI');
                window.fetch = this.originalFetch;
                console.log('ü§ñ AI Client Debugger Disabled');
                this.updateStatus();
                this.logToOutput('ü§ñ AI Debugging Disabled');
            }

            setupFetchInterceptor() {
                const self = this;

                window.fetch = function(...args) {
                    const [url, options] = args;
                    const isAIRequest = self.isAIRequest(url.toString());

                    if (self.enabled && isAIRequest) {
                        const requestId = self.generateRequestId();
                        self.activeRequests++;

                        console.group('ü§ñ AI Request Debug');
                        console.log('üÜî Request ID:', requestId.slice(-6));
                        console.log('üîó URL:', url);
                        console.log('üìä Method:', options?.method || 'GET');
                        console.time(`‚è±Ô∏è AI Request ${requestId.slice(-6)}`);

                        self.logToOutput(`üîÑ Request: ${requestId.slice(-6)} to ${url}`);
                    }

                    const startTime = Date.now();

                    return self.originalFetch.apply(this, args)
                        .then(response => {
                            const duration = Date.now() - startTime;

                            if (self.enabled && isAIRequest) {
                                self.activeRequests--;

                                console.log('‚úÖ Status:', response.status);
                                console.log('‚è±Ô∏è Duration:', `${duration}ms`);
                                console.timeEnd(`‚è±Ô∏è AI Request ${requestId.slice(-6)}`);

                                // Performance analysis
                                const performance = self.analyzePerformance(duration, response.status);
                                console.log('üìä Performance:', performance);

                                console.groupEnd();

                                self.logToOutput(`‚úÖ Response: ${response.status} in ${duration}ms (${performance.rating})`);

                                // Try to extract and display token info
                                if (response.ok) {
                                    response.clone().json().then(data => {
                                        if (data.metadata?.tokensUsed) {
                                            console.table([{
                                                'Input Tokens': data.metadata.tokensUsed.input,
                                                'Output Tokens': data.metadata.tokensUsed.output,
                                                'Total Tokens': data.metadata.tokensUsed.input + data.metadata.tokensUsed.output,
                                                'Estimated Cost': `$${data.metadata.cost?.toFixed(4) || 'N/A'}`,
                                                'Provider': data.metadata.provider,
                                                'Tokens/Second': Math.round((data.metadata.tokensUsed.input + data.metadata.tokensUsed.output) / (duration / 1000))
                                            }]);

                                            self.logToOutput(`ü™ô Tokens: ${data.metadata.tokensUsed.input + data.metadata.tokensUsed.output} ($${data.metadata.cost?.toFixed(4) || 'N/A'})`);
                                        }
                                    }).catch(() => {});
                                }
                            }

                            return response;
                        })
                        .catch(error => {
                            const duration = Date.now() - startTime;

                            if (self.enabled && isAIRequest) {
                                self.activeRequests--;

                                console.error('‚ùå Request failed:', error.message);
                                console.log('‚è±Ô∏è Duration:', `${duration}ms`);
                                console.timeEnd(`‚è±Ô∏è AI Request ${requestId.slice(-6)}`);
                                console.groupEnd();

                                self.logToOutput(`‚ùå Error: ${error.message} after ${duration}ms`);
                            }

                            throw error;
                        });
                };
            }

            isAIRequest(url) {
                const aiEndpoints = [
                    '/api/ai/', '/api/chat', '/unified-chat', '/performance',
                    'anthropic.com', 'openai.com', 'googleapis.com'
                ];
                return aiEndpoints.some(endpoint => url.includes(endpoint));
            }

            analyzePerformance(duration, status) {
                if (status >= 400) {
                    return { rating: 'error', message: `HTTP ${status} error`, color: 'red' };
                } else if (duration < 1000) {
                    return { rating: 'excellent', message: 'Very fast response', color: 'green' };
                } else if (duration < 3000) {
                    return { rating: 'good', message: 'Good response time', color: 'blue' };
                } else {
                    return { rating: 'slow', message: 'Slow response - consider optimization', color: 'orange' };
                }
            }

            generateRequestId() {
                return `req_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
            }

            setupGlobalAPI() {
                window.aiDebug = {
                    enable: (level) => this.enable(level),
                    disable: () => this.disable(),
                    logs: () => this.logs,
                    stats: () => this.getStats(),
                    clear: () => this.clearLogs(),
                    config: (newConfig) => this.updateConfig(newConfig)
                };
            }

            getStats() {
                return {
                    enabled: this.enabled,
                    activeRequests: this.activeRequests,
                    totalLogs: this.logs.length,
                    version: '2.0.0'
                };
            }

            clearLogs() {
                this.logs = [];
                console.log('üßπ AI debug logs cleared');
                this.logToOutput('üßπ Debug logs cleared');
            }

            updateStatus() {
                const statusEl = document.getElementById('debugStatus');
                if (this.enabled) {
                    statusEl.className = 'status enabled';
                    statusEl.innerHTML = '‚úÖ Debug Mode: Enabled';
                } else {
                    statusEl.className = 'status disabled';
                    statusEl.innerHTML = '‚ùå Debug Mode: Disabled';
                }
            }

            logToOutput(message) {
                const outputEl = document.getElementById('consoleOutput');
                const timestamp = new Date().toLocaleTimeString();
                outputEl.innerHTML += `[${timestamp}] ${message}<br>`;
                outputEl.scrollTop = outputEl.scrollHeight;
            }
        }

        // Initialize debugger
        const debugger = new ClientAIDebugger();

        // Global functions for buttons
        function enableDebug() {
            debugger.enable('detailed');
        }

        function disableDebug() {
            debugger.disable();
        }

        function clearLogs() {
            debugger.clearLogs();
        }

        function showStats() {
            const stats = debugger.getStats();
            console.table([stats]);
            debugger.logToOutput(`üìä Stats: ${JSON.stringify(stats)}`);
        }

        function testSingleRequest() {
            debugger.logToOutput('üöÄ Testing single AI request...');

            fetch('http://localhost:3000/api/ai/unified-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'What is photosynthesis? (Client Debug Test)',
                    context: {
                        subject: 'Biology',
                        studentLevel: 'class-11',
                        language: 'english'
                    },
                    options: {
                        provider: 'anthropic',
                        model: 'fast'
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                debugger.logToOutput('‚úÖ Single request test completed');
            })
            .catch(error => {
                debugger.logToOutput(`‚ùå Single request test failed: ${error.message}`);
            });
        }

        function testMultipleRequests() {
            debugger.logToOutput('üöÄ Testing multiple AI requests...');

            const requests = [
                { message: 'What is cellular respiration?', provider: 'anthropic' },
                { message: 'Explain DNA structure', provider: 'google' },
                { message: 'Define mitosis', provider: 'anthropic' }
            ];

            requests.forEach((req, index) => {
                setTimeout(() => {
                    fetch('http://localhost:3000/api/ai/unified-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: `${req.message} (Multi-test ${index + 1})`,
                            context: {
                                subject: 'Biology',
                                studentLevel: 'class-12',
                                language: 'english'
                            },
                            options: {
                                provider: req.provider,
                                model: 'fast'
                            }
                        })
                    }).catch(error => {
                        debugger.logToOutput(`‚ùå Multi-request ${index + 1} failed: ${error.message}`);
                    });
                }, index * 1000);
            });
        }

        function testErrorScenario() {
            debugger.logToOutput('üöÄ Testing error scenario...');

            fetch('http://localhost:3000/api/ai/unified-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: 'Error test',
                    options: {
                        provider: 'invalid-provider'
                    }
                })
            }).catch(error => {
                debugger.logToOutput('‚úÖ Error scenario test completed');
            });
        }

        function testPerformanceStress() {
            debugger.logToOutput('üöÄ Running performance stress test...');

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    fetch('http://localhost:3000/api/ai/performance?action=stats')
                        .catch(error => {
                            debugger.logToOutput(`‚ùå Stress test ${i + 1} failed: ${error.message}`);
                        });
                }, i * 200);
            }
        }

        // Initial status update
        debugger.updateStatus();
        debugger.logToOutput('ü§ñ Client-side AI debugging system initialized');
        debugger.logToOutput('üí° Open browser DevTools console for full debugging experience');
        debugger.logToOutput('üîó Visit http://localhost:3000/ai-debug-client for the full React interface');
    </script>
</body>
</html>