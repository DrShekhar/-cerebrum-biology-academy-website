generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model achievements {
  id              String          @id
  freeUserId      String
  type            AchievementType
  title           String
  description     String
  icon            String?
  points          Int             @default(0)
  currentProgress Int             @default(0)
  targetProgress  Int             @default(1)
  isCompleted     Boolean         @default(false)
  earnedAt        DateTime?
  createdAt       DateTime        @default(now())
  free_users      free_users      @relation(fields: [freeUserId], references: [id], onDelete: Cascade)
}

model activities {
  id          String   @id
  userId      String
  leadId      String?
  action      String
  description String
  metadata    Json?
  createdAt   DateTime @default(now())
  leads       leads?   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  users       users    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([leadId])
  @@index([userId, createdAt])
}

model analytics_events {
  id          String   @id
  userId      String?
  sessionId   String?
  eventType   String
  eventName   String
  properties  Json?
  pagePath    String?
  pageTitle   String?
  referrer    String?
  userAgent   String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  ipAddress   String?
  country     String?
  city        String?
  createdAt   DateTime @default(now())
}

model biology_topics {
  id              String          @id
  title           String
  slug            String          @unique
  content         String
  excerpt         String?
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  curriculum      String
  grade           String
  chapter         String
  difficulty      String          @default("Medium")
  keyPoints       Json?
  diagrams        Json?
  videoUrl        String?
  leadMagnetId    String?
  viewCount       Int             @default(0)
  leadConversions Int             @default(0)
  avgTimeOnPage   Int?
  bounceRate      Float?
  isPublished     Boolean         @default(false)
  publishedAt     DateTime?
  authorName      String?         @default("Dr. Shekhar C Singh")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  lead_magnets    lead_magnets?   @relation(fields: [leadMagnetId], references: [id])
  content_leads   content_leads[]

  @@index([curriculum, grade, chapter])
  @@index([isPublished, publishedAt])
  @@index([slug])
  @@index([viewCount])
}

model bookmarks {
  id            String        @id
  freeUserId    String
  chapterNoteId String
  notes         String?
  createdAt     DateTime      @default(now())
  chapter_notes chapter_notes @relation(fields: [chapterNoteId], references: [id], onDelete: Cascade)
  free_users    free_users    @relation(fields: [freeUserId], references: [id], onDelete: Cascade)

  @@unique([freeUserId, chapterNoteId])
}

model chapter_notes {
  id              String      @id
  title           String
  curriculum      String
  grade           String
  subject         String      @default("Biology")
  chapter         String
  topic           String?
  content         String
  summary         String?
  keyPoints       Json?
  diagrams        Json?
  difficulty      String      @default("Medium")
  estimatedTime   Int?
  downloadCount   Int         @default(0)
  viewCount       Int         @default(0)
  rating          Float       @default(0)
  ratingCount     Int         @default(0)
  slug            String      @unique
  metaDescription String?
  tags            Json?
  isPublished     Boolean     @default(false)
  publishedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  bookmarks       bookmarks[]

  @@index([curriculum, grade, chapter])
  @@index([slug])
}

model chapters {
  id              String            @id
  courseId        String
  title           String
  description     String?
  orderIndex      Int
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  courses         courses           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  study_materials study_materials[]
  topics          topics[]

  @@index([courseId, orderIndex])
}

model chat_history {
  id              String   @id
  userId          String?
  freeUserId      String?
  sessionId       String
  message         String
  isUserMessage   Boolean
  ncertReferences Json?
  relatedTopics   Json?
  confidence      Int?
  tokensUsed      Int?
  topic           String?
  difficulty      String?
  createdAt       DateTime @default(now())

  @@index([freeUserId, createdAt])
  @@index([sessionId, createdAt])
  @@index([userId, createdAt])
}

model communication_logs {
  id                String               @id
  userId            String?
  demoBookingId     String?
  type              CommunicationType
  channel           CommunicationChannel
  content           String
  subject           String?
  status            MessageStatus        @default(SENT)
  sentAt            DateTime             @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?
  whatsappMessageId String?
  emailMessageId    String?
  templateId        String?
  templateData      Json?
  createdAt         DateTime             @default(now())
  demo_bookings     demo_bookings?       @relation(fields: [demoBookingId], references: [id])
  users             users?               @relation(fields: [userId], references: [id])
}

model content_leads {
  id                  String          @id
  email               String?
  whatsappNumber      String?
  name                String?
  grade               String?
  interestedIn        String?
  source              String
  topicSlug           String?
  leadMagnetId        String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  utmContent          String?
  utmTerm             String?
  referrerUrl         String?
  landingPage         String?
  deviceType          String?
  browser             String?
  ipAddress           String?
  country             String?
  city                String?
  downloadCompleted   Boolean         @default(false)
  downloadedAt        DateTime?
  emailVerified       Boolean         @default(false)
  whatsappVerified    Boolean         @default(false)
  convertedToPaid     Boolean         @default(false)
  convertedAt         DateTime?
  enrollmentId        String?
  welcomeEmailSent    Boolean         @default(false)
  welcomeWhatsAppSent Boolean         @default(false)
  followUpCount       Int             @default(0)
  lastContactedAt     DateTime?
  leadScore           Int             @default(0)
  leadStage           String          @default("NEW")
  createdAt           DateTime        @default(now())
  updatedAt           DateTime
  lead_magnets        lead_magnets?   @relation(fields: [leadMagnetId], references: [id])
  biology_topics      biology_topics? @relation(fields: [topicSlug], references: [slug])

  @@index([convertedToPaid])
  @@index([createdAt])
  @@index([email])
  @@index([leadStage, leadScore])
  @@index([source, createdAt])
  @@index([topicSlug, createdAt])
  @@index([whatsappNumber])
}

model content_notifications {
  id              String             @id
  title           String
  message         String
  type            NotificationType
  targetUserIds   Json?
  targetCourseIds Json?
  sendToAll       Boolean            @default(false)
  materialId      String?
  courseId        String?
  channels        Json
  scheduledFor    DateTime?
  sentAt          DateTime?
  status          NotificationStatus @default(DRAFT)
  recipientCount  Int                @default(0)
  deliveredCount  Int                @default(0)
  failedCount     Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime

  @@index([materialId])
  @@index([status, scheduledFor])
}

model courses {
  id              String            @id
  name            String
  description     String?
  type            CourseType
  class           StudentClass
  duration        Int
  totalFees       Int
  syllabus        Json?
  features        Json?
  isActive        Boolean           @default(true)
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  chapters        chapters[]
  demo_bookings   demo_bookings[]
  enrollments     enrollments[]
  study_materials study_materials[]
}

model crm_communications {
  id                String     @id
  leadId            String
  type              CommType
  direction         Direction
  subject           String?
  message           String
  status            CommStatus @default(PENDING)
  sentById          String
  sentAt            DateTime   @default(now())
  whatsappMessageId String?
  templateName      String?
  callDuration      Int?
  callRecordingUrl  String?
  attachments       String[]
  leads             leads      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  users             users      @relation(fields: [sentById], references: [id])

  @@index([leadId, sentAt])
  @@index([sentById])
}

model demo_bookings {
  id                    String               @id
  userId                String?
  courseId              String?
  studentName           String
  email                 String?
  phone                 String
  studentClass          StudentClass?
  preferredDate         String
  preferredTime         String
  message               String?
  status                DemoBookingStatus    @default(PENDING)
  assignedTo            String?
  followUpDate          DateTime?
  remindersSent         Int                  @default(0)
  demoCompleted         Boolean              @default(false)
  demoRating            Int?
  demoFeedback          String?
  convertedToEnrollment Boolean              @default(false)
  source                String?
  utmSource             String?
  utmMedium             String?
  utmCampaign           String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime
  demoType              DemoType             @default(FREE)
  paymentAmount         Int?
  paymentCompletedAt    DateTime?
  paymentStatus         DemoPaymentStatus    @default(NOT_REQUIRED)
  razorpayOrderId       String?              @unique
  razorpayPaymentId     String?              @unique
  referralCodeUsed      String?
  referralDiscount      Int?
  notificationsSent     Json?                @default("{\"email\": false, \"whatsapp\": false}")
  communication_logs    communication_logs[]
  courses               courses?             @relation(fields: [courseId], references: [id])
  users                 users?               @relation(fields: [userId], references: [id])
  leads                 leads?

  @@index([assignedTo, status])
  @@index([email])
  @@index([phone])
  @@index([preferredDate, status])
  @@index([status, createdAt])
}

model enrollments {
  id              String           @id
  userId          String
  courseId        String
  status          EnrollmentStatus @default(PENDING)
  enrollmentDate  DateTime         @default(now())
  startDate       DateTime?
  endDate         DateTime?
  totalFees       Int
  paidAmount      Int              @default(0)
  pendingAmount   Int              @default(0)
  paymentPlan     PaymentPlan      @default(FULL)
  currentProgress Int              @default(0)
  lastAccessDate  DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  courses         courses          @relation(fields: [courseId], references: [id])
  users           users            @relation(fields: [userId], references: [id])
  payments        payments[]

  @@unique([userId, courseId])
  @@index([courseId, status])
  @@index([enrollmentDate])
  @@index([status, createdAt])
  @@index([userId, status])
}

model fee_payments {
  id                String    @id
  feePlanId         String
  installmentId     String?
  amount            Decimal   @db.Decimal(10, 2)
  paymentMethod     String
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
  status            String
  paidAt            DateTime?
  metadata          Json?
  receiptUrl        String?
  createdAt         DateTime  @default(now())
  fee_plans         fee_plans @relation(fields: [feePlanId], references: [id])

  @@index([feePlanId, createdAt])
}

model fee_plans {
  id                   String         @id
  leadId               String
  courseId             String
  courseName           String
  baseFee              Decimal        @db.Decimal(10, 2)
  discount             Decimal        @default(0) @db.Decimal(10, 2)
  discountType         DiscountType   @default(PERCENTAGE)
  totalFee             Decimal        @db.Decimal(10, 2)
  amountPaid           Decimal        @default(0) @db.Decimal(10, 2)
  amountDue            Decimal        @db.Decimal(10, 2)
  planType             String
  numberOfInstallments Int
  status               FeeStatus      @default(PENDING)
  createdById          String
  createdAt            DateTime       @default(now())
  updatedAt            DateTime
  fee_payments         fee_payments[]
  users                users          @relation(fields: [createdById], references: [id])
  leads                leads          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  installments         installments[]

  @@index([createdById])
  @@index([leadId, status])
}

model forum_posts {
  id            String          @id
  freeUserId    String
  title         String
  content       String
  topic         String
  type          PostType        @default(QUESTION)
  upvotes       Int             @default(0)
  views         Int             @default(0)
  isResolved    Boolean         @default(false)
  isPinned      Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  free_users    free_users      @relation(fields: [freeUserId], references: [id], onDelete: Cascade)
  forum_replies forum_replies[]

  @@index([topic, createdAt])
}

model forum_replies {
  id          String      @id
  postId      String
  content     String
  authorName  String
  upvotes     Int         @default(0)
  isAccepted  Boolean     @default(false)
  createdAt   DateTime    @default(now())
  forum_posts forum_posts @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model free_users {
  id                      String                    @id
  email                   String                    @unique
  name                    String?
  grade                   String?
  curriculum              String?
  school                  String?
  city                    String?
  totalPoints             Int                       @default(0)
  studyStreak             Int                       @default(0)
  lastActiveDate          DateTime?
  preferences             Json?
  registrationDate        DateTime                  @default(now())
  updatedAt               DateTime
  adaptiveData            Json?
  averageScore            Float?
  bestScore               Float?
  currentLevel            Int                       @default(1)
  strongestTopics         Json?
  totalTestsTaken         Int                       @default(0)
  weakestTopics           Json?
  deviceId                String?
  extensionCount          Int                       @default(0)
  isTrialExpired          Boolean                   @default(false)
  lastTrialCheck          DateTime                  @default(now())
  testsTakenCount         Int                       @default(0)
  trialExpiryDate         DateTime?
  trialExtended           Boolean                   @default(false)
  trialStartDate          DateTime                  @default(now())
  upgradedToUserId        String?
  achievements            achievements[]
  bookmarks               bookmarks[]
  forum_posts             forum_posts[]
  performance_reports     performance_reports[]
  study_plans             study_plans[]
  test_attempts           test_attempts[]
  test_sessions           test_sessions[]
  user_progress           user_progress[]
  user_question_responses user_question_responses[]

  @@index([deviceId])
  @@index([trialExpiryDate, isTrialExpired])
  @@index([upgradedToUserId])
}

model installments {
  id                String            @id
  feePlanId         String
  installmentNumber Int
  amount            Decimal           @db.Decimal(10, 2)
  dueDate           DateTime
  status            PaymentStatusEnum @default(PENDING)
  paidAt            DateTime?
  paidAmount        Decimal?          @db.Decimal(10, 2)
  razorpayOrderId   String?
  razorpayPaymentId String?
  paymentLink       String?
  remindersSent     Json?             @default("{\"1_day\": false, \"7_days\": false, \"due_date\": false}")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  fee_plans         fee_plans         @relation(fields: [feePlanId], references: [id], onDelete: Cascade)

  @@index([feePlanId, dueDate])
  @@index([status, dueDate])
}

model lead_magnets {
  id               String           @id
  title            String
  description      String
  fileType         String
  fileUrl          String?
  fileSize         Int?
  thumbnailUrl     String?
  requiresEmail    Boolean          @default(true)
  requiresWhatsApp Boolean          @default(false)
  requiresName     Boolean          @default(true)
  features         Json?
  previewPages     Int?
  downloadCount    Int              @default(0)
  conversionRate   Float?
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  biology_topics   biology_topics[]
  content_leads    content_leads[]
}

model leads {
  id                 String               @id
  studentName        String
  email              String?
  phone              String
  courseInterest     String
  stage              LeadStage            @default(NEW_LEAD)
  priority           Priority             @default(WARM)
  assignedToId       String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  lastContactedAt    DateTime?
  nextFollowUpAt     DateTime?
  convertedAt        DateTime?
  lostAt             DateTime?
  lostReason         String?
  demoBookingId      String?              @unique
  source             LeadSource           @default(MANUAL_ENTRY)
  activities         activities[]
  crm_communications crm_communications[]
  fee_plans          fee_plans[]
  users              users                      @relation(fields: [assignedToId], references: [id])
  demo_bookings      demo_bookings?             @relation(fields: [demoBookingId], references: [id])
  notes              notes[]
  offers             offers[]
  tasks              tasks[]
  whatsapp_conversations whatsapp_conversations[]

  @@index([assignedToId, stage])
  @@index([createdAt])
  @@index([email])
  @@index([nextFollowUpAt])
  @@index([phone])
}

model material_access {
  id              String          @id
  materialId      String
  userId          String
  grantedBy       String
  grantedAt       DateTime        @default(now())
  expiresAt       DateTime?
  reason          String?
  study_materials study_materials @relation(fields: [materialId], references: [id], onDelete: Cascade)
  users           users           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([materialId, userId])
  @@index([userId])
}

model material_progress {
  id              String          @id
  materialId      String
  userId          String
  status          ProgressStatus  @default(NOT_STARTED)
  firstViewedAt   DateTime?
  lastViewedAt    DateTime?
  downloadedAt    DateTime?
  completedAt     DateTime?
  currentPage     Int?
  totalPages      Int?
  timeSpent       Int             @default(0)
  rating          Int?
  feedback        String?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  study_materials study_materials @relation(fields: [materialId], references: [id], onDelete: Cascade)
  users           users           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([materialId, userId])
  @@index([materialId, updatedAt])
  @@index([userId, status])
}

model message_templates {
  id          String   @id
  name        String
  type        CommType
  subject     String?
  message     String
  isActive    Boolean  @default(true)
  usageCount  Int      @default(0)
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  users       users    @relation(fields: [createdById], references: [id])

  @@index([type, isActive])
}

model notes {
  id          String   @id
  leadId      String
  content     String
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  users       users    @relation(fields: [createdById], references: [id])
  leads       leads    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
}

model offers {
  id              String       @id
  leadId          String
  offerCode       String       @unique
  offerName       String
  courseName      String
  originalPrice   Decimal      @db.Decimal(10, 2)
  discountType    DiscountType
  discountValue   Decimal      @db.Decimal(10, 2)
  finalPrice      Decimal      @db.Decimal(10, 2)
  validFrom       DateTime     @default(now())
  validUntil      DateTime
  isActive        Boolean      @default(true)
  status          OfferStatus  @default(SENT)
  sentAt          DateTime     @default(now())
  viewedAt        DateTime?
  acceptedAt      DateTime?
  termsConditions String?
  maxUses         Int          @default(1)
  usesCount       Int          @default(0)
  createdById     String
  offerCardUrl    String?
  createdAt       DateTime     @default(now())
  users           users        @relation(fields: [createdById], references: [id])
  leads           leads        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([leadId, status])
  @@index([validUntil])
}

model otp_verifications {
  id        String   @id
  mobile    String
  otp       String
  purpose   String
  verified  Boolean  @default(false)
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@index([expiresAt])
  @@index([mobile, createdAt])
  @@index([mobile])
}

model payments {
  id                String        @id
  userId            String
  enrollmentId      String?
  amount            Int
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)
  paymentMethod     PaymentMethod
  razorpayOrderId   String?       @unique
  razorpayPaymentId String?       @unique
  razorpaySignature String?
  transactionId     String?
  failureReason     String?
  installmentNumber Int?
  totalInstallments Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  completedAt       DateTime?
  enrollments       enrollments?  @relation(fields: [enrollmentId], references: [id])
  users             users         @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([enrollmentId, status])
  @@index([status, completedAt])
  @@index([userId, status])
}

model performance_reports {
  id              String      @id
  userId          String?
  freeUserId      String?
  reportType      ReportType  @default(WEEKLY)
  reportPeriod    String
  testsAttempted  Int         @default(0)
  averageScore    Float?
  totalStudyTime  Int         @default(0)
  improvementRate Float?
  biologyScore    Float?
  botanyScore     Float?
  zoologyScore    Float?
  strongTopics    Json?
  weakTopics      Json?
  improvingTopics Json?
  targetScore     Float?
  targetDate      DateTime?
  onTrackStatus   Boolean     @default(true)
  studyPlan       Json?
  focusAreas      Json?
  practiceTests   Json?
  periodStart     DateTime
  periodEnd       DateTime
  generatedAt     DateTime    @default(now())
  free_users      free_users? @relation(fields: [freeUserId], references: [id])
  users           users?      @relation(fields: [userId], references: [id])

  @@unique([freeUserId, reportType, reportPeriod])
  @@unique([userId, reportType, reportPeriod])
  @@index([reportType, periodStart])
}

model question_bank_questions {
  id             String          @id
  questionBankId String
  questionId     String
  testTemplateId String?
  orderIndex     Int
  groupLabel     String?
  question_banks question_banks  @relation(fields: [questionBankId], references: [id], onDelete: Cascade)
  questions      questions       @relation(fields: [questionId], references: [id], onDelete: Cascade)
  test_templates test_templates? @relation(fields: [testTemplateId], references: [id])

  @@unique([questionBankId, questionId])
  @@index([questionBankId, orderIndex])
}

model question_banks {
  id                      String                    @id
  name                    String
  description             String?
  category                QuestionBankCategory      @default(CUSTOM)
  curriculum              String
  grade                   String
  subject                 String                    @default("biology")
  topics                  Json?
  totalQuestions          Int                       @default(0)
  activeQuestions         Int                       @default(0)
  usageCount              Int                       @default(0)
  isActive                Boolean                   @default(true)
  isPublic                Boolean                   @default(false)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  createdBy               String?
  question_bank_questions question_bank_questions[]
}

model questions {
  id                      String                    @id
  topic                   String
  subtopic                String?
  curriculum              String
  grade                   String
  type                    QuestionType
  question                String
  options                 Json?
  correctAnswer           String
  explanation             String?
  source                  String?
  marks                   Int                       @default(1)
  timeLimit               Int?
  tags                    Json?
  totalAttempts           Int                       @default(0)
  correctAttempts         Int                       @default(0)
  averageTime             Int?
  isActive                Boolean                   @default(true)
  isVerified              Boolean                   @default(false)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  category                QuestionCategory          @default(PRACTICE)
  conversionRate          Float?
  difficultyRating        Float?
  examYear                Int?
  explanationImage        String?
  keywords                Json?
  lastUsed                DateTime?
  popularityScore         Float                     @default(0)
  qualityScore            Float?
  questionImage           String?
  relatedConcepts         Json?
  reportCount             Int                       @default(0)
  slug                    String?                   @unique
  solutionSteps           Json?
  subject                 String                    @default("biology")
  variantId               String?
  verifiedBy              String?
  videoExplanation        String?
  difficulty              DifficultyLevel           @default(MEDIUM)
  question_bank_questions question_bank_questions[]
  test_questions          test_questions[]
  user_question_responses user_question_responses[]

  @@index([curriculum, grade])
  @@index([isActive, isVerified])
  @@index([popularityScore])
  @@index([subject, type])
  @@index([topic, difficulty])
}

model referral_codes {
  id                   String                 @id
  code                 String                 @unique
  userId               String?
  userEmail            String
  uses                 Int                    @default(0)
  maxUses              Int                    @default(10)
  discount             Int
  expiresAt            DateTime?
  createdAt            DateTime               @default(now())
  referral_redemptions referral_redemptions[]

  @@index([code])
  @@index([userEmail])
}

model referral_redemptions {
  id              String         @id
  referralCodeId  String
  redeemedBy      String
  redeemedByEmail String
  discountGiven   Int
  bookingId       String?
  createdAt       DateTime       @default(now())
  referral_codes  referral_codes @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  @@index([redeemedByEmail])
  @@index([referralCodeId])
}

model reschedule_tokens {
  id        String   @id
  bookingId String   @unique
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([token])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model study_materials {
  id                String              @id
  title             String
  description       String?
  materialType      MaterialType
  fileUrl           String
  fileName          String
  fileSize          Int
  mimeType          String              @default("application/pdf")
  courseId          String?
  chapterId         String?
  topicId           String?
  tags              Json?
  accessLevel       AccessLevel         @default(ENROLLED)
  requiredCourseId  String?
  sortOrder         Int                 @default(0)
  category          String?
  uploadedBy        String
  isPublished       Boolean             @default(false)
  publishedAt       DateTime?
  totalDownloads    Int                 @default(0)
  totalViews        Int                 @default(0)
  avgRating         Float               @default(0)
  ratingCount       Int                 @default(0)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  material_access   material_access[]
  material_progress material_progress[]
  chapters          chapters?           @relation(fields: [chapterId], references: [id])
  courses           courses?            @relation(fields: [courseId], references: [id])
  topics            topics?             @relation(fields: [topicId], references: [id])

  @@index([courseId, isPublished])
  @@index([createdAt])
  @@index([materialType, accessLevel])
}

model study_plans {
  id              String     @id
  freeUserId      String
  title           String
  targetExam      String
  examDate        DateTime?
  schedule        Json
  currentWeek     Int        @default(1)
  totalWeeks      Int
  completedTopics Json?
  currentTopic    String?
  overallProgress Int        @default(0)
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime
  free_users      free_users @relation(fields: [freeUserId], references: [id], onDelete: Cascade)
}

model tasks {
  id                              String       @id
  leadId                          String?
  title                           String
  description                     String?
  type                            TaskType
  priority                        TaskPriority @default(MEDIUM)
  dueDate                         DateTime
  dueTime                         String?
  status                          TaskStatus   @default(PENDING)
  completedAt                     DateTime?
  assignedToId                    String
  createdById                     String?
  isAutoGenerated                 Boolean      @default(false)
  triggerEvent                    String?
  snoozedUntil                    DateTime?
  createdAt                       DateTime     @default(now())
  updatedAt                       DateTime
  users_tasks_assignedToIdTousers users        @relation("tasks_assignedToIdTousers", fields: [assignedToId], references: [id])
  users_tasks_createdByIdTousers  users?       @relation("tasks_createdByIdTousers", fields: [createdById], references: [id])
  leads                           leads?       @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([assignedToId, status, dueDate])
  @@index([dueDate, status])
  @@index([leadId])
}

model test_analytics {
  id                   String        @id
  testSessionId        String        @unique
  totalTime            Int
  averageTimePerQ      Float
  questionsAttempted   Int
  questionsCorrect     Int
  accuracy             Float
  questionsSkipped     Int           @default(0)
  questionsRevisited   Int           @default(0)
  timeDistribution     Json
  answerPattern        Json
  easyQuestions        Json
  mediumQuestions      Json
  hardQuestions        Json
  topicPerformance     Json
  strengthTopics       Json
  weaknessTopics       Json
  percentileRank       Float?
  averageComparison    Float?
  predictedScore       Float?
  recommendedStudyTime Int?
  analyzedAt           DateTime      @default(now())
  test_sessions        test_sessions @relation(fields: [testSessionId], references: [id], onDelete: Cascade)
}

model test_attempts {
  id               String           @id
  freeUserId       String
  title            String
  topics           Json?
  questionCount    Int
  timeLimit        Int?
  score            Int
  totalMarks       Int
  percentage       Float
  timeSpent        Int
  topicWiseScore   Json
  strengthAreas    Json?
  weaknessAreas    Json?
  recommendations  Json?
  status           TestStatus       @default(IN_PROGRESS)
  startedAt        DateTime         @default(now())
  submittedAt      DateTime?
  accuracy         Float?
  consistency      Float?
  improvementAreas Json?
  rank             Int?
  speed            Float?
  testTemplateId   String?
  difficulty       DifficultyLevel  @default(MEDIUM)
  free_users       free_users       @relation(fields: [freeUserId], references: [id], onDelete: Cascade)
  test_templates   test_templates?  @relation(fields: [testTemplateId], references: [id])
  test_questions   test_questions[]

  @@index([freeUserId, startedAt])
  @@index([percentage])
  @@index([testTemplateId])
}

model test_questions {
  id                String        @id
  testAttemptId     String
  questionId        String
  selectedAnswer    String?
  isCorrect         Boolean?
  timeSpent         Int?
  marksAwarded      Int           @default(0)
  attempts          Int           @default(1)
  confidenceLevel   Int?
  isMarkedForReview Boolean       @default(false)
  questions         questions     @relation(fields: [questionId], references: [id])
  test_attempts     test_attempts @relation(fields: [testAttemptId], references: [id], onDelete: Cascade)

  @@unique([testAttemptId, questionId])
}

model test_sessions {
  id                       String                    @id
  userId                   String?
  freeUserId               String?
  testTemplateId           String
  sessionToken             String                    @unique
  status                   TestSessionStatus         @default(NOT_STARTED)
  startedAt                DateTime?
  pausedAt                 DateTime?
  resumedAt                DateTime?
  submittedAt              DateTime?
  timeSpent                Int                       @default(0)
  remainingTime            Int?
  currentQuestionIndex     Int                       @default(0)
  questionsAnswered        Int                       @default(0)
  questionsMarkedForReview Int                       @default(0)
  browserInfo              Json?
  ipAddress                String?
  locationData             Json?
  tabSwitchCount           Int                       @default(0)
  fullscreenExits          Int                       @default(0)
  suspiciousActivity       Json?
  isProctored              Boolean                   @default(false)
  totalScore               Int?
  percentage               Float?
  rank                     Int?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime
  test_analytics           test_analytics?
  free_users               free_users?               @relation(fields: [freeUserId], references: [id])
  test_templates           test_templates            @relation(fields: [testTemplateId], references: [id])
  users                    users?                    @relation(fields: [userId], references: [id])
  user_question_responses  user_question_responses[]

  @@index([freeUserId, status])
  @@index([sessionToken])
  @@index([testTemplateId, submittedAt])
  @@index([userId, status])
}

model test_templates {
  id                      String                    @id
  title                   String
  description             String?
  slug                    String                    @unique
  type                    TestType                  @default(PRACTICE_TEST)
  category                TestCategory              @default(TOPIC_WISE)
  difficulty              DifficultyLevel           @default(MEDIUM)
  timeLimit               Int
  totalQuestions          Int
  totalMarks              Int
  passingMarks            Int?
  curriculum              String
  grade                   String
  subject                 String                    @default("biology")
  topics                  Json
  negativeMarking         Boolean                   @default(false)
  markingScheme           Json?
  questionDistribution    Json?
  instructions            Json?
  isAdaptive              Boolean                   @default(false)
  adaptiveSettings        Json?
  attemptCount            Int                       @default(0)
  averageScore            Float?
  averageTime             Int?
  popularityScore         Float                     @default(0)
  isActive                Boolean                   @default(true)
  isPremium               Boolean                   @default(false)
  isPublished             Boolean                   @default(false)
  publishedAt             DateTime?
  seoTitle                String?
  seoDescription          String?
  seoKeywords             Json?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  createdBy               String?
  question_bank_questions question_bank_questions[]
  test_attempts           test_attempts[]
  test_sessions           test_sessions[]

  @@index([curriculum, grade])
  @@index([isActive, isPublished])
  @@index([popularityScore])
  @@index([type, category])
}

model topics {
  id              String            @id
  chapterId       String
  title           String
  description     String?
  orderIndex      Int
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  study_materials study_materials[]
  chapters        chapters          @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId, orderIndex])
}

model user_progress {
  id              String          @id
  userId          String?
  freeUserId      String?
  topic           String
  subtopic        String?
  curriculum      String
  grade           String
  totalQuestions  Int             @default(0)
  correctAnswers  Int             @default(0)
  accuracy        Float           @default(0)
  averageTime     Int?
  improvementRate Float           @default(0)
  currentLevel    DifficultyLevel @default(EASY)
  masteryScore    Float           @default(0)
  recommendedNext Json?
  weakAreas       Json?
  strongAreas     Json?
  lastPracticed   DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  free_users      free_users?     @relation(fields: [freeUserId], references: [id])
  users           users?          @relation(fields: [userId], references: [id])

  @@unique([freeUserId, topic, curriculum, grade])
  @@unique([userId, topic, curriculum, grade])
  @@index([topic, masteryScore])
}

model user_question_responses {
  id             String         @id
  userId         String?
  freeUserId     String?
  questionId     String
  testSessionId  String?
  selectedAnswer String?
  isCorrect      Boolean?
  timeSpent      Int?
  marksAwarded   Int            @default(0)
  confidence     Int?
  responseMode   ResponseMode   @default(TEST_MODE)
  deviceType     String?
  answeredAt     DateTime       @default(now())
  free_users     free_users?    @relation(fields: [freeUserId], references: [id])
  questions      questions      @relation(fields: [questionId], references: [id])
  test_sessions  test_sessions? @relation(fields: [testSessionId], references: [id])
  users          users?         @relation(fields: [userId], references: [id])

  @@index([freeUserId, answeredAt])
  @@index([questionId, isCorrect])
  @@index([userId, answeredAt])
}

model users {
  id                              String                    @id
  email                           String                    @unique
  phone                           String?                   @unique
  name                            String
  role                            UserRole                  @default(STUDENT)
  passwordHash                    String?
  emailVerified                   DateTime?
  phoneVerified                   DateTime?
  profile                         Json?
  createdAt                       DateTime                  @default(now())
  updatedAt                       DateTime
  lastActiveAt                    DateTime?
  activities                      activities[]
  communication_logs              communication_logs[]
  crm_communications              crm_communications[]
  demo_bookings                   demo_bookings[]
  enrollments                     enrollments[]
  fee_plans                       fee_plans[]
  leads                           leads[]
  material_access                 material_access[]
  material_progress               material_progress[]
  message_templates               message_templates[]
  notes                           notes[]
  offers                          offers[]
  payments                        payments[]
  performance_reports             performance_reports[]
  sessions                        sessions[]
  tasks_tasks_assignedToIdTousers tasks[]                   @relation("tasks_assignedToIdTousers")
  tasks_tasks_createdByIdTousers  tasks[]                   @relation("tasks_createdByIdTousers")
  test_sessions                   test_sessions[]
  user_progress                   user_progress[]
  user_question_responses         user_question_responses[]
  whatsapp_conversations          whatsapp_conversations[]  @relation("AssignedCounselor")
  whatsapp_messages_sent          whatsapp_messages[]       @relation("SentByUser")
}

enum AccessLevel {
  FREE
  ENROLLED
  PREMIUM
  SPECIFIC_COURSE
}

enum AchievementType {
  FIRST_TEST
  STREAK_7_DAYS
  STREAK_30_DAYS
  TOPIC_MASTER
  SPEED_DEMON
  PERFECTIONIST
  COMMUNITY_HELPER
  BOOKWORM
}

enum CommStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum CommType {
  WHATSAPP
  EMAIL
  CALL
  SMS
}

enum CommunicationChannel {
  WHATSAPP
  EMAIL
  SMS
  PHONE_CALL
  IN_APP_NOTIFICATION
}

enum CommunicationType {
  WELCOME_MESSAGE
  DEMO_CONFIRMATION
  DEMO_REMINDER
  ENROLLMENT_CONFIRMATION
  PAYMENT_REMINDER
  COURSE_UPDATE
  MARKETING_MESSAGE
  SUPPORT_MESSAGE
  FEEDBACK_REQUEST
  CUSTOM_MESSAGE
}

enum CourseType {
  NEET_COMPLETE
  CLASS_11
  CLASS_12
  DROPPER
  FOUNDATION
  CRASH_COURSE
}

enum DemoBookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
  RESCHEDULED
}

enum DemoPaymentStatus {
  NOT_REQUIRED
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DemoType {
  FREE
  PREMIUM
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  SUSPENDED
}

enum FeeStatus {
  PENDING
  PARTIAL
  COMPLETED
  CANCELLED
}

enum LeadSource {
  MANUAL_ENTRY
  WALK_IN
  PHONE_CALL
  REFERRAL
  WHATSAPP
  EMAIL
  SOCIAL_MEDIA
  WEBSITE
  ADVERTISEMENT
  EVENT
  OTHER
}

enum LeadStage {
  NEW_LEAD
  DEMO_SCHEDULED
  DEMO_COMPLETED
  OFFER_SENT
  NEGOTIATING
  PAYMENT_PLAN_CREATED
  ENROLLED
  ACTIVE_STUDENT
  LOST
}

enum MaterialType {
  PDF_NOTES
  PDF_ASSIGNMENT
  PDF_PRACTICE_PAPER
  PDF_REFERENCE
  PDF_EBOOK
  VIDEO
  LINK
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
  PENDING
}

enum NotificationStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum NotificationType {
  NEW_MATERIAL
  ASSIGNMENT_REMINDER
  COURSE_UPDATE
  ANNOUNCEMENT
  CUSTOM
}

enum OfferStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  RAZORPAY_UPI
  RAZORPAY_CARD
  RAZORPAY_NETBANKING
  RAZORPAY_WALLET
  BANK_TRANSFER
  CASH
  CHEQUE
}

enum PaymentPlan {
  FULL
  QUARTERLY
  MONTHLY
  CUSTOM
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentStatusEnum {
  PENDING
  PAID
  OVERDUE
  FAILED
}

enum PostType {
  QUESTION
  DISCUSSION
  TIP
  RESOURCE
  ANNOUNCEMENT
}

enum Priority {
  HOT
  WARM
  COLD
}

enum ProgressStatus {
  NOT_STARTED
  VIEWED
  IN_PROGRESS
  DOWNLOADED
  COMPLETED
}

enum QuestionBankCategory {
  NEET_PREVIOUS_YEAR
  CBSE_BOARD
  NCERT_BASED
  COMPETITIVE
  CONCEPT_BUILDER
  CUSTOM
  PRACTICE_SET
}

enum QuestionCategory {
  PRACTICE
  MOCK_TEST
  PREVIOUS_YEAR
  CONCEPT_BUILDER
  COMPETITIVE
}

enum QuestionType {
  MCQ
  SHORT_ANSWER
  DIAGRAM
  TRUE_FALSE
  FILL_BLANK
  MULTIPLE_SELECT
  MATCH_FOLLOWING
  NUMERICAL
}

enum ReportType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  CUSTOM
}

enum ResponseMode {
  TEST_MODE
  PRACTICE_MODE
  REVIEW_MODE
  STUDY_MODE
}

enum StudentClass {
  CLASS_9
  CLASS_10
  CLASS_11
  CLASS_12
  DROPPER
  FOUNDATION
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SNOOZED
  CANCELLED
}

enum TaskType {
  FOLLOW_UP_CALL
  SEND_WHATSAPP
  SEND_EMAIL
  PAYMENT_REMINDER
  DEMO_FOLLOWUP
  CUSTOM
}

enum TestCategory {
  TOPIC_WISE
  SUBJECT_WISE
  FULL_SYLLABUS
  CHAPTER_WISE
  DIFFICULTY_WISE
  PREVIOUS_YEAR
  MIXED
}

enum TestSessionStatus {
  NOT_STARTED
  IN_PROGRESS
  PAUSED
  COMPLETED
  EXPIRED
  ABANDONED
  TERMINATED
}

enum TestStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
  EXPIRED
}

enum TestType {
  PRACTICE_TEST
  MOCK_TEST
  FULL_TEST
  QUICK_TEST
  ADAPTIVE_TEST
  TIMED_TEST
  DIAGNOSTIC_TEST
}

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  ADMIN
  COUNSELOR
}

// WhatsApp Integration Tables
model whatsapp_otp {
  id          String   @id @default(cuid())
  phone       String
  otp         String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([phone, expiresAt])
  @@index([phone, verified])
}

model whatsapp_conversations {
  id                String                 @id @default(cuid())
  phone             String
  leadId            String?
  assignedCounselorId String?
  lastMessageAt     DateTime               @default(now())
  status            ConversationStatus     @default(ACTIVE)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  leads             leads?                 @relation(fields: [leadId], references: [id], onDelete: SetNull)
  users             users?                 @relation("AssignedCounselor", fields: [assignedCounselorId], references: [id], onDelete: SetNull)
  messages          whatsapp_messages[]

  @@index([phone])
  @@index([leadId])
  @@index([assignedCounselorId])
  @@index([status, lastMessageAt])
}

model whatsapp_messages {
  id             String                @id @default(cuid())
  conversationId String
  messageId      String?               @unique
  phone          String
  direction      MessageDirection
  content        String
  messageType    String                @default("text")
  mediaUrl       String?
  status         MessageStatus         @default(SENT)
  sentBy         String?
  timestamp      DateTime              @default(now())
  createdAt      DateTime              @default(now())
  conversation   whatsapp_conversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  users          users?                @relation("SentByUser", fields: [sentBy], references: [id], onDelete: SetNull)

  @@index([conversationId, timestamp])
  @@index([phone])
  @@index([messageId])
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}
