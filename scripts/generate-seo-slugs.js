#!/usr/bin/env node

/**
 * Generate SEO Slugs Static File
 *
 * This script extracts slugs from all SEO content files and generates
 * a static TypeScript file with just the slugs (no heavy content).
 *
 * Usage:
 *   node scripts/generate-seo-slugs.js
 *   or
 *   npm run generate:seo-slugs
 *
 * Output:
 *   src/data/seo-landing/slugs-static.ts
 */

const fs = require('fs')
const path = require('path')

const SEO_LANDING_DIR = path.join(__dirname, '../src/data/seo-landing')
const OUTPUT_FILE = path.join(SEO_LANDING_DIR, 'slugs-static.ts')

async function extractSlugsFromFile(filePath, categoryName) {
  try {
    // Read file content
    const content = fs.readFileSync(filePath, 'utf-8')

    // Extract all slug values using regex
    const slugMatches = content.matchAll(/slug:\s*['"`]([^'"`]+)['"`]/g)
    const slugs = []

    for (const match of slugMatches) {
      slugs.push(match[1])
    }

    console.log(`‚úì Extracted ${slugs.length} slugs from ${categoryName}`)
    return slugs
  } catch (error) {
    console.error(`‚úó Error reading ${categoryName}:`, error)
    return []
  }
}

async function generateSlugsFile() {
  console.log('üîç Extracting SEO page slugs...\n')

  const contentFiles = [
    { file: 'class-9-content.ts', category: 'class9', label: 'Class 9' },
    { file: 'class-10-content.ts', category: 'class10', label: 'Class 10' },
    { file: 'class-11-content.ts', category: 'class11', label: 'Class 11' },
    { file: 'class-12-content.ts', category: 'class12', label: 'Class 12' },
    { file: 'dropper-content.ts', category: 'dropper', label: 'Dropper' },
    { file: 'universal-content.ts', category: 'universal', label: 'Universal' },
    { file: 'ncert-content.ts', category: 'ncert', label: 'NCERT' },
    { file: 'topics-content.ts', category: 'topics', label: 'Topics' },
    {
      file: 'international-content.ts',
      category: 'international',
      label: 'International',
    },
    {
      file: 'neet-guide-content.ts',
      category: 'neetGuide',
      label: 'NEET Guide',
    },
    {
      file: 'resources-content.ts',
      category: 'resources',
      label: 'Resources',
    },
    {
      file: 'chapter-notes-content.ts',
      category: 'chapterNotes',
      label: 'Chapter Notes',
    },
    {
      file: 'crash-course-content.ts',
      category: 'crashCourse',
      label: 'Crash Course',
    },
    {
      file: 'comparison-content.ts',
      category: 'comparison',
      label: 'Comparison',
    },
  ]

  const slugsByCategory = {}
  let totalSlugs = 0

  // Extract slugs from each file
  for (const { file, category, label } of contentFiles) {
    const filePath = path.join(SEO_LANDING_DIR, file)
    const slugs = await extractSlugsFromFile(filePath, label)
    slugsByCategory[category] = slugs
    totalSlugs += slugs.length
  }

  console.log(`\n‚úÖ Total slugs extracted: ${totalSlugs}\n`)

  // Generate TypeScript file content
  const fileContent = generateTypeScriptContent(slugsByCategory, totalSlugs)

  // Write to file
  fs.writeFileSync(OUTPUT_FILE, fileContent, 'utf-8')
  console.log(`üìù Generated: ${path.relative(process.cwd(), OUTPUT_FILE)}`)
  console.log(`\n‚ú® Done! Sitemap will now use ${totalSlugs} SEO slugs efficiently.\n`)
}

function generateTypeScriptContent(slugsByCategory, totalSlugs) {
  const today = new Date().toISOString().split('T')[0]

  let content = `/**
 * Static SEO Page Slugs - Memory Efficient
 *
 * This file contains a pre-generated list of ALL SEO landing page slugs.
 * It is used by sitemap.ts to avoid loading 14 large content files (650KB+) into memory.
 *
 * MAINTENANCE:
 * - This file is AUTO-GENERATED by scripts/generate-seo-slugs.js
 * - DO NOT edit manually
 * - Run \`npm run generate:seo-slugs\` after adding/removing SEO pages
 * - Last generated: ${today}
 * - Total pages: ${totalSlugs}
 *
 * @see scripts/generate-seo-slugs.js
 */

/**
 * All SEO landing page slugs organized by category
 */
export const SEO_PAGE_SLUGS = {
`

  // Add each category
  const categories = Object.keys(slugsByCategory)
  categories.forEach((category, index) => {
    const slugs = slugsByCategory[category]
    const isLast = index === categories.length - 1

    content += `  ${category}: [\n`
    slugs.forEach((slug, slugIndex) => {
      const comma = slugIndex < slugs.length - 1 ? ',' : ''
      content += `    '${slug}'${comma}\n`
    })
    content += `  ]${isLast ? '' : ','}\n`
  })

  content += `} as const

/**
 * Flattened array of all SEO page slugs
 * Use this for sitemap generation and slug validation
 */
export const ALL_SEO_SLUGS: readonly string[] = [
`

  categories.forEach((category, index) => {
    const isLast = index === categories.length - 1
    content += `  ...SEO_PAGE_SLUGS.${category}${isLast ? '' : ','}\n`
  })

  content += `] as const

/**
 * Get all SEO page slugs for sitemap generation
 * This function replaces getAllSEOSlugs() from index.ts
 */
export function getAllSEOSlugs(): string[] {
  return [...ALL_SEO_SLUGS]
}

/**
 * Get slugs by category
 */
export function getSEOSlugsByCategory(
  category: keyof typeof SEO_PAGE_SLUGS
): readonly string[] {
  return SEO_PAGE_SLUGS[category]
}

/**
 * Check if a slug is a valid SEO page
 */
export function isValidSEOSlug(slug: string): boolean {
  return ALL_SEO_SLUGS.includes(slug as any)
}

/**
 * Get total count of SEO pages
 */
export function getSEOPageCount(): number {
  return ALL_SEO_SLUGS.length
}

/**
 * Metadata about the slugs
 */
export const SEO_SLUGS_METADATA = {
  totalCount: ${totalSlugs},
  lastGenerated: '${today}',
  categories: [${categories.map((c) => `'${c}'`).join(', ')}],
  categoryCounts: {
${categories.map((category) => `    ${category}: ${slugsByCategory[category].length}`).join(',\n')}
  },
} as const
`

  return content
}

// Run the script
generateSlugsFile().catch((error) => {
  console.error('‚ùå Error generating slugs file:', error)
  process.exit(1)
})
