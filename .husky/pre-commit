#!/usr/bin/env sh

echo "Running pre-commit checks..."

# ================================
# SECRETS DETECTION - BLOCKING
# ================================
echo "üîê Checking for secrets and sensitive files..."

# Check for .env files being staged (except .env.example)
STAGED_ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env($|\.local$|\.production$|\.development$)' || true)
if [ -n "$STAGED_ENV_FILES" ]; then
  echo "‚ùå ERROR: Attempting to commit .env files!"
  echo "   Files detected:"
  echo "$STAGED_ENV_FILES" | sed 's/^/     - /'
  echo ""
  echo "   These files contain secrets and must NOT be committed."
  echo "   To unstage: git reset HEAD <file>"
  exit 1
fi

# Check for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|yml|yaml|sh|env)$' || true)
if [ -n "$STAGED_FILES" ]; then
  # Patterns to detect secrets (case-insensitive)
  SECRET_PATTERNS='(sk-[a-zA-Z0-9]{20,}|sk_live_[a-zA-Z0-9]+|AKIA[A-Z0-9]{16}|ghp_[a-zA-Z0-9]{36}|xox[baprs]-[a-zA-Z0-9-]+|-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----)'

  for file in $STAGED_FILES; do
    if git show ":$file" 2>/dev/null | grep -qE "$SECRET_PATTERNS"; then
      echo "‚ùå ERROR: Potential secrets detected in: $file"
      echo "   Please review and remove any API keys, tokens, or credentials."
      exit 1
    fi
  done
fi

echo "‚úÖ No secrets detected in staged files"
echo ""

# Run lint-staged (code formatting) - BLOCKING
npx lint-staged

# Type checking - NON-BLOCKING (warning only)
echo "üîß Type checking (non-blocking)..."
npm run type-check || echo "‚ö†Ô∏è  Type errors found - review before deployment"

# Run tests - NON-BLOCKING (warning only)
echo "üß™ Running tests (non-blocking)..."
npm test -- --passWithNoTests || echo "‚ö†Ô∏è  Test failures found - review before deployment"

# Security check - NON-BLOCKING (warning only)
echo "üõ°Ô∏è Security audit (warnings only)..."
npm audit --audit-level=high || echo "‚ö†Ô∏è  Security issues found - review in Phase 2"

echo "‚úÖ Pre-commit checks completed!"
